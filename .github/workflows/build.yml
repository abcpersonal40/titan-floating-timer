name: Build Signed Floating Timer

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
      
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'
      
      - name: Install Dependencies
        run: npm install

      # ‡¶ì‡ßü‡ßá‡¶¨ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶∏‡ßá‡¶ü ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§ ‡¶ï‡¶∞‡¶æ
      - name: Prepare Web Assets
        run: |
          mkdir -p www
          cp index.html www/
          cp overlay.html www/
          echo "Web assets copied."

      - name: Initialize Capacitor
        run: |
          npx cap add android
          npx cap sync

      # ‡¶™‡¶æ‡¶∞‡¶Æ‡¶ø‡¶∂‡¶® ‡¶á‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶®
      - name: Inject Permissions
        run: |
          MANIFEST="android/app/src/main/AndroidManifest.xml"
          sed -i '/<manifest/a \    <uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW" />' $MANIFEST
          sed -i '/<manifest/a \    <uses-permission android:name="android.permission.ACTION_MANAGE_OVERLAY_PERMISSION" />' $MANIFEST
          sed -i '/<manifest/a \    <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />' $MANIFEST
        shell: bash

      # üî• ‡¶®‡¶§‡ßÅ‡¶® ‡¶ß‡¶æ‡¶™: ‡¶Ö‡¶ü‡ßã‡¶Æ‡ßá‡¶ü‡¶ø‡¶ï Keystore ‡¶§‡ßà‡¶∞‡¶ø ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶æ‡¶á‡¶®‡¶ø‡¶Ç ‡¶ï‡¶®‡¶´‡¶ø‡¶ó üî•
      - name: Configure Keystore & Signing
        run: |
          # ‡ßß. ‡¶è‡¶ï‡¶ü‡¶ø ‡¶ü‡ßá‡¶Æ‡ßç‡¶™‡ßã‡¶∞‡¶æ‡¶∞‡¶ø Keystore ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ
          keytool -genkey -v \
            -keystore android/app/release.keystore \
            -alias androidreleasekey \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -storetype JKS \
            -dname "CN=TitanTimer, OU=Dev, O=Titan, L=Dhaka, S=Dhaka, C=BD" \
            -storepass "password123" \
            -keypass "password123"

          # ‡ß®. build.gradle ‡¶´‡¶æ‡¶á‡¶≤‡ßá ‡¶∏‡¶æ‡¶á‡¶®‡¶ø‡¶Ç ‡¶ï‡¶®‡¶´‡¶ø‡¶ó ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶æ
          GRADLE_FILE="android/app/build.gradle"
          
          cat >> $GRADLE_FILE <<EOF
          android {
              signingConfigs {
                  release {
                      storeFile file("release.keystore")
                      storePassword "password123"
                      keyAlias "androidreleasekey"
                      keyPassword "password123"
                  }
              }
              buildTypes {
                  release {
                      signingConfig signingConfigs.release
                  }
              }
          }
          EOF
        shell: bash

      # ‡¶¨‡¶ø‡¶≤‡ßç‡¶° (‡¶è‡¶ñ‡¶® ‡¶∏‡¶æ‡¶á‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá)
      - name: Build Signed Release APK
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleRelease

      # APK ‡¶Ü‡¶™‡¶≤‡ßã‡¶°
      - name: Upload Signed APK
        uses: actions/upload-artifact@v4
        with:
          name: titan-timer-signed
          path: android/app/build/outputs/apk/release/app-release.apk
          
