name: Build Signed Floating Timer

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
      
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'
      
      # ‡¶°‡¶ø‡¶™‡ßá‡¶®‡ßç‡¶°‡ßá‡¶®‡ßç‡¶∏‡¶ø ‡¶è‡¶¨‡¶Ç ‡¶™‡ßç‡¶≤‡¶æ‡¶ó‡¶ø‡¶® ‡¶á‡¶®‡¶∏‡ßç‡¶ü‡¶≤
      - name: Install Dependencies
        run: |
          npm install
          npm install cordova-open-native-settings
          npx cap add android
          npx cap sync

      # ‡¶ì‡ßü‡ßá‡¶¨ ‡¶´‡¶æ‡¶á‡¶≤ ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶æ
      - name: Prepare Web Assets
        run: |
          mkdir -p www
          cp index.html www/
          cp overlay.html www/

      # ‡¶™‡¶æ‡¶∞‡¶Æ‡¶ø‡¶∂‡¶® ‡¶á‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶® (System Overlay & Foreground)
      - name: Inject Manifest Permissions
        run: |
          MANIFEST="android/app/src/main/AndroidManifest.xml"
          sed -i '/<manifest/a \    <uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW" />' $MANIFEST
          sed -i '/<manifest/a \    <uses-permission android:name="android.permission.ACTION_MANAGE_OVERLAY_PERMISSION" />' $MANIFEST
          sed -i '/<manifest/a \    <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />' $MANIFEST
        shell: bash

      # üî• ‡¶Ö‡¶ü‡ßã‡¶Æ‡ßá‡¶ü‡¶ø‡¶ï Keystore ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü ‡¶è‡¶¨‡¶Ç ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® üî•
      - name: Configure Signing
        run: |
          keytool -genkey -v -keystore android/app/release.keystore -alias titan -keyalg RSA -keysize 2048 -validity 10000 -storetype JKS -dname "CN=Titan, OU=Dev, O=TitanApp, L=Dhaka, S=Dhaka, C=BD" -storepass "titan123" -keypass "titan123"

          cat >> android/app/build.gradle <<EOF
          android {
              signingConfigs {
                  release {
                      storeFile file("release.keystore")
                      storePassword "titan123"
                      keyAlias "titan"
                      keyPassword "titan123"
                  }
              }
              buildTypes {
                  release {
                      signingConfig signingConfigs.release
                  }
              }
          }
          EOF
        shell: bash

      # ‡¶´‡¶æ‡¶á‡¶®‡¶æ‡¶≤ ‡¶¨‡¶ø‡¶≤‡ßç‡¶°
      - name: Build Release APK
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleRelease

      # APK ‡¶Ü‡¶™‡¶≤‡ßã‡¶°
      - name: Upload Signed APK
        uses: actions/upload-artifact@v4
        with:
          name: titan-floating-timer-signed
          path: android/app/build/outputs/apk/release/app-release.apk
